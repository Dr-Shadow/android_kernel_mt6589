#include <linux/kernel.h>
#include <linux/types.h>
#include <linux/xlog.h>
#include <linux/spinlock.h>
#include <mach/mt_clkmgr.h>
#include <mach/mt_gpio.h>

#include "ddp_reg.h"
#include "ddp_path.h"
#include "ddp_color.h"

extern unsigned char pq_debug_flag;

// initailize 
static DISP_PQ_PARAM g_Color_Param = 
{
u4SHPGain:0,
u4SatGain:0,
u4HueAdj:{0,0,0,0},
u4SatAdj:{0,0,0,0}
};

static DISP_PQ_PARAM g_Color_Cam_Param = 
{
u4SHPGain:0,
u4SatGain:0,
u4HueAdj:{0,0,0,0},
u4SatAdj:{0,0,0,0}
};

static DISP_PQ_PARAM g_Color_Gal_Param = 
{
u4SHPGain:0,
u4SatGain:0,
u4HueAdj:{0,0,0,0},
u4SatAdj:{0,0,0,0}
};

//COLOR_TUNING_INDEX : 10

//initialize index (because system default is 0, need fill with 0x80)
static DISPLAY_PQ_T g_Color_Index =
{
GLOBAL_SAT   :
{0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80}, //0~10
PARTIAL_Y    :
{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
PURP_TONE_S  :
{//hue 0~10
	{//0 disable  
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80}
	}, 

	{//1
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80}
	},
	
	{//2
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80}
	},
	{//3
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80}
	},
	
	{//4
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80}
	},
	
	{//5
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80}
	},

	{//6
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80}
	},
  // 7
	{
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80}
	},
	// 8
	{
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80}
	},
	// 9
	{
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80}
	}
},
SKIN_TONE_S:
{
	{//0 disable  
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80}
	},

	{//1
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80}
	},
	
	{//2
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80}
	},
	
	{//3
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80}
	},

	{//4
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80}
	},
	
	{//5
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80}
	},
	{//6
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80}
	},
	
	{//7
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80}
	},
	
	{//8
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80}
	},
	
	{//9
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80}
	}
},
GRASS_TONE_S:
{
	{//0 disable  
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80}
	},

	{//1
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80}
	},
	
	{//2
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80}

	},

	{//3
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80}

	},
	
	{//4
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80}

	},

	{//5
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80}

	},
	
	{//6
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80}

	},

	{//7
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80}
	},
	
	{//8
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80}
	},
	
	{//9
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80}
	}
},
SKY_TONE_S:
{
	{//0 disable
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80}
	},
	{//1
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80}

	},
	{//2
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80}

	},

	{//3
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80}

	},
	{//4
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80}

	},

	{//5
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80}
	},
	
	{//6
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80}
	},
	
	{//7
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80}
	},
	
	{//8
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80}
	},
	
	{//9
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80},
		{0x80, 0x80, 0x80}
	}
},

PURP_TONE_H :
{ 
//hue 0~2 
    {0x80, 0x80, 0x80},//3 
    {0x80, 0x80, 0x80},//4 
    {0x80, 0x80, 0x80},
    {0x80, 0x80, 0x80},//3 
    {0x80, 0x80, 0x80},//4 
    {0x80, 0x80, 0x80},
    {0x80, 0x80, 0x80},
    {0x80, 0x80, 0x80},
    {0x80, 0x80, 0x80},
    {0x80, 0x80, 0x80}
},
	
SKIN_TONE_H:
{
//hue 3~16
    {0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},   
    {0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
    {0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
    {0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
    {0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
    {0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
    {0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
    {0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
    {0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
    {0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80}
},
	
GRASS_TONE_H :
{
// hue 17~24
	{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
	{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
	{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
	{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
	{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
	{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
	{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
	{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
	{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80},
	{0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80}
},

SKY_TONE_H:
{
        {0x80, 0x80, 0x80},
        {0x80, 0x80, 0x80},
        {0x80, 0x80, 0x80},
        {0x80, 0x80, 0x80},
        {0x80, 0x80, 0x80},
        {0x80, 0x80, 0x80},
        {0x80, 0x80, 0x80},
        {0x80, 0x80, 0x80},
        {0x80, 0x80, 0x80},
        {0x80, 0x80, 0x80}
}

};

static unsigned long g_Color_Window = 0;

//static unsigned int gHist[LUMA_HIST_BIN];
static DISP_AAL_STATISTICS gHist;
static unsigned long gHistIndicator = 0;
spinlock_t gHistLock;


void disp_set_hist_readlock(unsigned long bLock)
{
    unsigned long flag;

    spin_lock_irqsave(&gHistLock , flag);

    gHistIndicator = bLock;

    spin_unlock_irqrestore(&gHistLock , flag);
}

int disp_get_hist(unsigned int * pHist)
{
    disp_set_hist_readlock(1);

    memcpy(pHist , gHist.histogram  , (LUMA_HIST_BIN*sizeof(unsigned int)));
    
    disp_set_hist_readlock(0);
    return 0;
}

DISP_AAL_STATISTICS * disp_get_hist_ptr()
{
    return &gHist;
}

void disp_update_hist()
{
    int i = 0;
    unsigned long flag;

    spin_lock_irqsave(&gHistLock , flag);

    if(~gHistIndicator)
    {
        for (i = 0; i < LUMA_HIST_BIN; i++)
        {
            gHist.histogram[i] = DISP_REG_GET(DISPSYS_COLOR_BASE + 0x0520 + i * 4);
        }

        gHist.ChromHist = DISP_REG_GET(DISPSYS_COLOR_BASE + 0x74C);

        DISP_REG_SET((DISPSYS_BLS_BASE + 0x1c) , 1);
        for (i = 0; i < BLS_HIST_BIN; i++)
        {
            gHist.BLSHist[i] = DISP_REG_GET(DISPSYS_BLS_BASE + 0x100 + i * 4);
        }
        DISP_REG_SET((DISPSYS_BLS_BASE + 0x1c) , 0);
    }

    spin_unlock_irqrestore(&gHistLock , flag);

}

void disp_color_set_window(unsigned int sat_upper, unsigned int sat_lower,
                           unsigned int hue_upper, unsigned int hue_lower)
{
    g_Color_Window = (sat_upper << 24) | (sat_lower << 16) | (hue_upper << 8) | (hue_lower);
}


void disp_onConfig_luma(unsigned long * luma)
{
    unsigned long u4Index;
    unsigned long u4Val;
    
    for(u4Index = 0 ; u4Index < 16; u4Index += 1)
    {
        u4Val = luma[u4Index*2] | luma[u4Index*2+1] << 16;
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0x440 + (u4Index << 2)), u4Val);
    }
    DISP_REG_SET((DISPSYS_COLOR_BASE + 0x440 + (16 << 2)), luma[32]);    
}

/*
*g_Color_Param
*/

DISP_PQ_PARAM * get_Color_config()
{
    return &g_Color_Param;
}


DISP_PQ_PARAM * get_Color_Cam_config(void)
{
    return &g_Color_Cam_Param;
}

DISP_PQ_PARAM * get_Color_Gal_config(void)
{
    return &g_Color_Gal_Param;
}
/*
*g_Color_Index
*/

DISPLAY_PQ_T * get_Color_index()
{
    return &g_Color_Index;
}


void DpEngine_COLORonInit(void)
{
        //XLOGD("init COLOR \n");

        spin_lock_init(&gHistLock);

        if(pq_debug_flag == 1) //PQ Off
        {
            DISP_REG_SET(CFG_MAIN,(1<<29) | (1<<7)); //color all bypass
        }
        else
        {
            DISP_REG_SET(CFG_MAIN,(1<<29)); //color enable
        }

        if(pq_debug_flag == 2) //demo
        {
            DISP_REG_SET((DISPSYS_COLOR_BASE + 0x420),1<<3);
        }
        else
        {
            DISP_REG_SET((DISPSYS_COLOR_BASE + 0x420),0);
        }

        
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0xf00), 0x00000001); //color start

        //enable interrupt
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0xf04), 0x00000007);

        //init color matrix
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0xf64), 306  );
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0xf68), 601  );
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0xf6c), 117  );
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0xf70), -173 );
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0xf74), -339 );
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0xf78), 512  );
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0xf7c), 512  );
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0xf80), -429 );
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0xf84), -83  );
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0xf88), 0    );
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0xf8c), 0    );
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0xf90),0     );
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0xf94),0     );
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0xf98),128   );
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0xf9c),128   );
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0xfa0), 1    );
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0xfa4), 1024 );
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0xfa8), -1   );
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0xfac), 1436 );
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0xfb0), 1024 );
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0xfb4), -353 );
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0xfb8), -731 );
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0xfbc), 1024 );
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0xfc0), 1814 );
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0xfc4), 1    );
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0xfc8), 0    );
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0xfcc), -128 );
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0xfd0), -128 );
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0xfd4), 0    );
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0xfd8), 0    );
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0xfdc), 0    );

#if defined (MTK_AAL_SUPPORT)
        //config cboost
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0x428), 0xFF402280);
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0x42c), 0x00000000);
#endif
}



void DpEngine_COLORonConfig(unsigned int srcWidth,unsigned int srcHeight)
{
	 int index = 0;
    unsigned int u4Temp = 0;
    unsigned char h_series[28]={0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};

    //XLOGD("config COLOR %d %d \n", srcWidth, srcHeight);
    DISP_REG_SET((DISPSYS_COLOR_BASE + 0xf50), srcWidth);  //wrapper width
    DISP_REG_SET((DISPSYS_COLOR_BASE + 0xf54), srcHeight); //wrapper height
   // 0x040C  WIN_X_MAIN  32      Window X    Window X    COLOR_CFG   WrWIN_X     31  16  win_x_end   RW  PUBLIC  16'hFFFF        X end for processing window
   //                         COLOR_CFG           15  0   win_x_start RW  PUBLIC  16'h0000        X start for processing window

    if(pq_debug_flag == 2) 
    {
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0x40C),(srcWidth/2)<<16);
    }
    else
    {
        DISP_REG_SET((DISPSYS_COLOR_BASE + 0x40C),(0xFFFF)<<16);
    }

    // enable R2Y/Y2R in Color Wrapper
    DISP_REG_SET((DISPSYS_COLOR_BASE + 0xf60), 1    );
    DISP_REG_SET((DISPSYS_COLOR_BASE +  0xfa0), 1    );


	//config parameter from customer folder by DpConfig

	if(g_Color_Param.u4SatGain>= COLOR_TUNING_INDEX ||
	   g_Color_Param.u4HueAdj[PURP_TONE] >= COLOR_TUNING_INDEX ||
	   g_Color_Param.u4HueAdj[SKIN_TONE] >= COLOR_TUNING_INDEX ||
	   g_Color_Param.u4HueAdj[GRASS_TONE] >= COLOR_TUNING_INDEX|| 
	   g_Color_Param.u4HueAdj[SKY_TONE] >= COLOR_TUNING_INDEX || 
	   g_Color_Param.u4SatAdj[PURP_TONE] >= COLOR_TUNING_INDEX ||
	   g_Color_Param.u4SatAdj[SKIN_TONE] >= COLOR_TUNING_INDEX ||
	   g_Color_Param.u4SatAdj[GRASS_TONE] >= COLOR_TUNING_INDEX|| 
	   g_Color_Param.u4SatAdj[SKY_TONE] >= COLOR_TUNING_INDEX )
	{
		//XLOGD("COLOR Tuning index range error !\n");
		return;
	}
   
   
	DISP_REG_SET(G_PIC_ADJ_MAIN_2, (0x200<<16) |g_Color_Index.GLOBAL_SAT[g_Color_Param.u4SatGain]);

	// Partial Y Function
	for (index = 0; index < 8; index++)
	{
        DISP_REG_SET(Y_SLOPE_1_0_MAIN + 4 * index, (g_Color_Index.PARTIAL_Y[2 * index ] | g_Color_Index.PARTIAL_Y[2 * index + 1]<<16));
	}

	// Partial Saturation Function


    DISP_REG_SET(DISP_COLOR_CK_ON, 0x1); //*(volatile kal_uint32 *)(0x1400A000 + 0xf28) = 0x1;	 //Force clock on when program SRAM (only in 6589)
    

    DISP_REG_SET(LOCAL_SAT_1, (1<<30|1<<10|0xFF));             // enable cpu RW
    DISP_REG_SET(LOCAL_SAT_2, 0);              // set initial address to 0

    for (index = 0; index < 3; index++)
    {
		u4Temp = (g_Color_Index.PURP_TONE_S[g_Color_Param.u4SatAdj[PURP_TONE]][SG3][index]);
        DISP_REG_SET(LOCAL_SAT_4, u4Temp);

        u4Temp = (g_Color_Index.PURP_TONE_S[g_Color_Param.u4SatAdj[PURP_TONE]][SP1][index]) +
                 (g_Color_Index.PURP_TONE_S[g_Color_Param.u4SatAdj[PURP_TONE]][SP2][index] << 8) +
                 (g_Color_Index.PURP_TONE_S[g_Color_Param.u4SatAdj[PURP_TONE]][SG1][index] << 16) +
                 (g_Color_Index.PURP_TONE_S[g_Color_Param.u4SatAdj[PURP_TONE]][SG2][index] << 24);
        DISP_REG_SET(LOCAL_SAT_3, u4Temp);   // LOCAL_SAT_3: SRAM addr increment trigger

    }

	for (index = 0; index < 14; index++)
    {
        u4Temp = (g_Color_Index.SKIN_TONE_S[g_Color_Param.u4SatAdj[SKIN_TONE]][SG3][index]);
        DISP_REG_SET(LOCAL_SAT_4, u4Temp);

        u4Temp = (g_Color_Index.SKIN_TONE_S[g_Color_Param.u4SatAdj[SKIN_TONE]][SP1][index]) +
                 (g_Color_Index.SKIN_TONE_S[g_Color_Param.u4SatAdj[SKIN_TONE]][SP2][index] << 8) +
                 (g_Color_Index.SKIN_TONE_S[g_Color_Param.u4SatAdj[SKIN_TONE]][SG1][index] << 16) +
                 (g_Color_Index.SKIN_TONE_S[g_Color_Param.u4SatAdj[SKIN_TONE]][SG2][index] << 24);
        DISP_REG_SET(LOCAL_SAT_3, u4Temp);   // LOCAL_SAT_3: SRAM addr increment trigger

    }

	for (index = 0; index < 8; index++)
    {
        u4Temp = (g_Color_Index.GRASS_TONE_S[g_Color_Param.u4SatAdj[GRASS_TONE]][SG3][index]);
        DISP_REG_SET(LOCAL_SAT_4, u4Temp);

        u4Temp = (g_Color_Index.GRASS_TONE_S[g_Color_Param.u4SatAdj[GRASS_TONE]][SP1][index]) +
                 (g_Color_Index.GRASS_TONE_S[g_Color_Param.u4SatAdj[GRASS_TONE]][SP2][index] << 8) +
                 (g_Color_Index.GRASS_TONE_S[g_Color_Param.u4SatAdj[GRASS_TONE]][SG1][index] << 16) +
                 (g_Color_Index.GRASS_TONE_S[g_Color_Param.u4SatAdj[GRASS_TONE]][SG2][index] << 24);
        DISP_REG_SET(LOCAL_SAT_3, u4Temp);   // LOCAL_SAT_3: SRAM addr increment trigger

    }

	for (index = 0; index < 3; index++)
    {
        u4Temp = (g_Color_Index.SKY_TONE_S[g_Color_Param.u4SatAdj[SKY_TONE]][SG3][index]);
        DISP_REG_SET(LOCAL_SAT_4, u4Temp);

        u4Temp = (g_Color_Index.SKY_TONE_S[g_Color_Param.u4SatAdj[SKY_TONE]][SP1][index]) +
                 (g_Color_Index.SKY_TONE_S[g_Color_Param.u4SatAdj[SKY_TONE]][SP2][index] << 8) +
                 (g_Color_Index.SKY_TONE_S[g_Color_Param.u4SatAdj[SKY_TONE]][SG1][index] << 16) +
                 (g_Color_Index.SKY_TONE_S[g_Color_Param.u4SatAdj[SKY_TONE]][SG2][index] << 24);
        DISP_REG_SET(LOCAL_SAT_3, u4Temp);   // LOCAL_SAT_3: SRAM addr increment trigger

    }


    DISP_REG_SET(LOCAL_SAT_1, 0);	 // enable cpu RW // set write auto-incremental
    DISP_REG_SET(LOCAL_SAT_2, 0);


	DISP_REG_SET(DISP_COLOR_CK_ON, 0x0); 	//leave force clock on mode
	
	for (index = 0; index < 3; index++)
    {
		h_series[index+PURP_TONE_START] = g_Color_Index.PURP_TONE_H[g_Color_Param.u4HueAdj[PURP_TONE]][index];
	}

	for (index = 0; index < 14; index++)
    {
		h_series[index+SKIN_TONE_START] = g_Color_Index.SKIN_TONE_H[g_Color_Param.u4HueAdj[SKIN_TONE]][index];
	}

	for (index = 0; index < 8; index++)
    {
		h_series[index+GRASS_TONE_START] = g_Color_Index.GRASS_TONE_H[g_Color_Param.u4HueAdj[GRASS_TONE]][index];
	}

	for (index = 0; index < 3; index++)
    {
		h_series[index+SKY_TONE_START] = g_Color_Index.SKY_TONE_H[g_Color_Param.u4HueAdj[SKY_TONE]][index];
	}

    for (index = 0; index < 7; index++)
    {
        u4Temp = (h_series[4 * index]) +
                 (h_series[4 * index + 1] << 8) +
                 (h_series[4 * index + 2] << 16) +
                 (h_series[4 * index + 3] << 24);
        DISP_REG_SET(LOCAL_HUE_CD_0 + 4 * index, u4Temp);

    }

    // color window
    DISP_REG_SET((DISPSYS_COLOR_BASE+0x740), g_Color_Window);
}





